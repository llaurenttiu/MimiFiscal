<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MimiFiscal – Asistent fiscal digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <section id="demo" class="py-16 px-4 flex justify-center">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl p-6 transition relative">
      <h2 class="text-2xl font-bold mb-4 text-center">💬 MimiFiscal Chatbot</h2>
      
      <!-- Container mesaje -->
      <div id="chat-container" class="h-96 overflow-y-auto border rounded-lg p-4 bg-gray-50"></div>
      <div id="loading-indicator" class="hidden text-center text-gray-500 mt-2">Se procesează...</div>
      
      <!-- Input + buton -->
      <div class="mt-4 flex">
        <input id="user-input" type="text" placeholder="Scrie întrebarea ta..." 
               class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
        
        <!-- Buton trimite cu icon -->
        <button id="send-button" 
                class="send-button bg-blue-700 text-white px-6 py-3 ml-2 rounded-full hover:bg-blue-800 transition transform hover:scale-105 shadow-md flex items-center justify-center space-x-2" 
                aria-label="Trimite întrebarea">
          <span>Trimite</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
      
      <!-- Buton try-free -->
      <button id="try-free-btn" 
              class="mt-4 w-full bg-green-600 text-white py-2 rounded-xl hover:bg-green-700 transition">
        Încearcă Gratuit
      </button>
    </div>
  </section>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
      const userInput = document.getElementById('user-input');
      const sendButton = document.getElementById('send-button');
      const chatContainer = document.getElementById('chat-container');
      const loadingIndicator = document.getElementById('loading-indicator');
      const tryFreeButton = document.getElementById('try-free-btn');
      const chatCard = document.querySelector('#demo .bg-white');

      const apiEndpoint = '/api/ask';
      const STORAGE_KEY = "mimifiscal_chat_history";

      // ===== Format timp =====
      function formatTime() {
          const d = new Date();
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // ===== Adaugă mesaj =====
      function addMessage(text, isUser = false, save = true, time = null) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `p-3 my-2 rounded-xl max-w-[85%] ${isUser ? 'bg-blue-100 ml-auto text-right' : 'bg-gray-200 mr-auto text-left'}`;

          const content = document.createElement('div');
          content.textContent = text;
          messageDiv.appendChild(content);

          const timeEl = document.createElement('div');
          timeEl.className = "text-xs text-gray-500 mt-1";
          timeEl.textContent = time ? time : formatTime();
          messageDiv.appendChild(timeEl);

          chatContainer.appendChild(messageDiv);
          messageDiv.scrollIntoView({ behavior: "smooth" });

          if (save) {
              saveMessage({ text, isUser, time: new Date().toISOString() });
          }
      }

      // ===== Persistență =====
      function saveMessage(msg) {
          const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
          history.push(msg);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      }

      function loadMessages() {
          const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
          history.forEach(m => {
              const localTime = new Date(m.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              addMessage(m.text, m.isUser, false, localTime);
          });
      }

      loadMessages();

      // ===== Fetch cu timeout =====
      async function fetchWithTimeout(resource, options = {}, timeout = 12000) {
          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), timeout);
          try {
              const response = await fetch(resource, { ...options, signal: controller.signal });
              clearTimeout(id);
              return response;
          } catch (err) {
              clearTimeout(id);
              throw err;
          }
      }

      // ===== Trimite mesaj =====
      async function sendMessage() {
          const prompt = userInput.value.trim();
          if (prompt === '') return;

          addMessage(prompt, true);
          userInput.value = '';
          userInput.disabled = true;
          sendButton.disabled = true;
          loadingIndicator.classList.remove('hidden');

          try {
              const response = await fetchWithTimeout(apiEndpoint, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ prompt: prompt })
              });

              if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`API response status: ${response.status}. Body: ${errorText}`);
              }

              const result = await response.json();
              const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Nu am putut găsi un răspuns. Te rog să încerci din nou.';
              addMessage(text, false);
          } catch (error) {
              console.error("Eroare la apelul către Vercel:", error);
              addMessage(`⚠️ A apărut o eroare sau conexiunea a expirat. Încearcă din nou.`, false);
          } finally {
              loadingIndicator.classList.add('hidden');
              userInput.disabled = false;
              sendButton.disabled = false;
              userInput.focus();
          }
      }

      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
              event.preventDefault();
              sendMessage();
          }
      });

      chatCard.addEventListener('mouseenter', () => {
          chatCard.classList.add('glowing');
      });
      chatCard.addEventListener('mouseleave', () => {
          chatCard.classList.remove('glowing');
      });

      tryFreeButton.addEventListener('click', () => {
          setTimeout(() => {
              userInput.focus();
          }, 100);
      });
  });
  </script>
</body>
</html>
